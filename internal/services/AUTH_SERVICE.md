# Auth Service - Сервис аутентификации

**Дата:** 14 декабря 2024  
**Задача:** 2.2 - Auth Service (Login, Logout, Remember Me)

## Обзор

Auth Service содержит бизнес-логику для аутентификации пользователей:
- **Login** - вход в систему
- **Logout** - выход из системы
- **AuthenticateByToken** - аутентификация по токену "Remember Me"

## Методы

### Login(login, password, remember) *LoginResult

Выполняет аутентификацию пользователя.

**Параметры:**
- `login` - логин пользователя
- `password` - пароль (в открытом виде)
- `remember` - нужно ли создать токен "Remember Me"

**Что делает:**
1. Находит пользователя по логину
2. Проверяет активность пользователя
3. Проверяет пароль через bcrypt
4. Загружает активные группы пользователя
5. Обновляет временную метку активности
6. Генерирует токен (если remember = true)

**Возвращает:**
- `*LoginResult` с данными пользователя и токеном

**Пример:**
```go
authService := services.NewAuthService()
result := authService.Login("admin", "password123", true)
if result.Error != nil {
    // Обработка ошибки
}
```

### Logout(userID) error

Выполняет выход пользователя из системы.

**Параметры:**
- `userID` - ID пользователя

**Что делает:**
1. Удаляет токен "Remember Me" из БД
2. Логирует выход

**Возвращает:**
- `error` - ошибка, если произошла ошибка БД

**Пример:**
```go
err := authService.Logout(userID)
if err != nil {
    // Обработка ошибки
}
```

### AuthenticateByToken(login, token) (*User, error)

Аутентифицирует пользователя по токену "Remember Me".

**Параметры:**
- `login` - логин из cookie
- `token` - токен из cookie

**Что делает:**
1. Находит пользователя по логину и токену
2. Проверяет активность пользователя
3. Загружает группы пользователя
4. Обновляет временную метку активности

**Возвращает:**
- `*models.User` - пользователь (если токен валиден)
- `error` - ошибка, если токен неверен

**Пример:**
```go
user, err := authService.AuthenticateByToken(login, token)
if err != nil {
    // Токен неверен
}
```

## Структура LoginResult

```go
type LoginResult struct {
    User  *models.User  // Данные пользователя
    Token string        // Токен для "Remember Me"
    Error error         // Ошибка (если есть)
}
```

## Обработка ошибок

Сервис возвращает следующие типы ошибок:

- **UnauthorizedError** - неверный логин/пароль, пользователь заблокирован, нет активных групп
- **InternalError** - ошибки БД, ошибки генерации токена

## Логирование

Все операции логируются:
- Успешный вход: `INFO` уровень
- Неудачный вход: `WARN` уровень
- Ошибки БД: `ERROR` уровень

## Безопасность

- Пароли проверяются через `bcrypt.CompareHashAndPassword`
- Токены генерируются криптографически стойким генератором
- Токены хранятся в БД и сравниваются при аутентификации

## Следующие шаги

- Задача 2.3: Password Hashing (bcrypt)
- Задача 2.4: Session Management (Cookie + DB token)
- Задача 2.5: Auth Middleware

---

*Auth Service готов к использованию!*

